# 가계부 애플리케이션 아키텍처 문서

## 1. Information Architecture (IA)

### 1.1 페이지 계층 구조

```
Root (__root.tsx)
├── 인증 레이어
│   ├── Login (로그인)
│   └── Register (회원가입 - 초대 토큰 기반)
│
└── 메인 애플리케이션 레이어
    ├── 주요 (Main)
    │   ├── / (목록) - ExpenseList
    │   └── /statistics (통계) - Statistics
    │
    ├── 입력 (Input)
    │   ├── /image (이미지 업로드) - ImageUpload
    │   └── /manual (수동 입력) - ManualEntry
    │
    ├── 관리 (Management)
    │   └── /recurring (고정비) - RecurringExpenses
    │
    └── 설정 (Settings)
        ├── /invite (초대) - InviteMember
        └── /profile (프로필) - Profile
```

### 1.2 기능 분류

#### 주요 기능 (Main)
- **목록**: 지출/수입 항목 조회, 필터링, 검색, 수정, 삭제
- **통계**: 기간별 통계, 카테고리별 분석

#### 입력 기능 (Input)
- **이미지 업로드**: 영수증 이미지 OCR을 통한 자동 입력
- **수동 입력**: 폼을 통한 직접 입력

#### 관리 기능 (Management)
- **고정비**: 반복되는 지출/수입 관리

#### 설정 기능 (Settings)
- **초대**: 가족 구성원 초대 링크 생성
- **프로필**: 닉네임, 프로필 이미지 관리

#### 공통 기능
- **AI 가이드**: 플로팅 챗봇을 통한 컨텍스트 기반 도움말 및 입력

## 2. User Flows

### 2.1 인증 플로우

```
시작
  ↓
[로그인 페이지]
  ↓
인증 성공?
  ├─ Yes → [메인 애플리케이션]
  └─ No → [로그인 페이지] (에러 표시)
```

### 2.2 초기 설정 플로우 (최초 관리자)

```
[로그인 페이지]
  ↓
초기 관리자 계정으로 로그인
  ↓
[새 관리자 등록 폼]
  ↓
새 관리자 등록
  ↓
초기 관리자 계정 삭제
  ↓
[메인 애플리케이션]
```

### 2.3 초대 플로우

```
[초대 페이지]
  ↓
초대 링크 생성
  ↓
링크 공유
  ↓
초대받은 사용자: 링크 클릭
  ↓
[회원가입 페이지] (토큰 포함)
  ↓
회원가입 완료
  ↓
[메인 애플리케이션]
```

### 2.4 지출/수입 입력 플로우

#### 2.4.1 이미지 업로드 플로우
```
[이미지 업로드 페이지]
  ↓
이미지 선택
  ↓
업로드 및 추출 버튼 클릭
  ↓
OCR 처리
  ↓
추출된 항목 확인
  ↓
항목 저장
  ↓
[목록 페이지] (새로고침)
```

#### 2.4.2 수동 입력 플로우
```
[수동 입력 페이지]
  ↓
폼 작성 (날짜, 유형, 금액, 카테고리, 설명)
  ↓
저장 버튼 클릭
  ↓
항목 저장
  ↓
폼 초기화
  ↓
[목록 페이지] (새로고침)
```

#### 2.4.3 AI 가이드 플로우
```
[어떤 페이지든]
  ↓
플로팅 AI 버튼 클릭
  ↓
[AI 가이드 창 열림]
  ↓
질문 입력
  ↓
AI 응답 및 항목 생성 (필요시)
  ↓
[목록 페이지] (새로고침)
```

### 2.5 항목 관리 플로우

```
[목록 페이지]
  ↓
항목 선택
  ├─ [수정] → [수정 다이얼로그] → 저장 → [목록 페이지]
  └─ [삭제] → [삭제 확인 다이얼로그] → 확인 → [목록 페이지]
```

### 2.6 고정비 관리 플로우

```
[고정비 페이지]
  ↓
고정비 추가
  ↓
고정비 목록 표시
  ├─ [수정] → [수정 다이얼로그] → 저장
  └─ [삭제] → [삭제 확인] → 삭제
  ↓
자동 처리 (서버 시작 시, 매일)
  ↓
[목록 페이지] (자동 추가된 항목 표시)
```

### 2.7 통계 조회 플로우

```
[통계 페이지]
  ↓
기간 선택 (기본: 현재 월)
  ↓
통계 데이터 로드
  ↓
차트 및 요약 정보 표시
```

## 3. 현재 아키텍처 분석

### 3.1 레이어 구조

```
┌─────────────────────────────────────┐
│         Presentation Layer           │
│  (Components, Routes, UI)           │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         State Management             │
│  (Zustand Stores)                    │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         Service Layer                │
│  (API Clients, Business Logic)       │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         API Layer                    │
│  (Backend REST API)                  │
└──────────────────────────────────────┘
```

### 3.2 의존성 흐름

**이상적인 흐름:**
```
Component → Store → Service → API
```

**현재 문제점:**
- 일부 컴포넌트가 Service를 직접 호출 (ImageUpload, FloatingChatWizard)
- Store와 Service의 책임이 중복됨
- Root 컴포넌트에 인증 로직과 레이아웃이 혼재

## 4. 커플링 문제 분석

### 4.1 높은 커플링 영역

1. **FloatingChatWizard**
   - `useExpenseStore` 직접 사용
   - `AIService` 직접 호출
   - `useLocation` 사용하여 라우팅에 의존
   - **문제**: AI 기능과 Expense 기능이 강하게 결합

2. **ImageUpload**
   - `ImageService` 직접 호출
   - `useExpenseStore` 직접 사용
   - **문제**: 이미지 처리와 Expense 관리가 강하게 결합

3. **__root.tsx**
   - 인증 로직 포함
   - 레이아웃 로직 포함
   - 라우팅 로직 포함
   - **문제**: 단일 책임 원칙 위반

4. **ExpenseList**
   - `useExpenseStore` 사용
   - 필터링, 정렬 로직 포함
   - UI 렌더링 로직 포함
   - **문제**: 비즈니스 로직과 UI 로직 혼재

### 4.2 의존성 그래프

```
__root.tsx
├── useAuthStore (인증)
├── FloatingChatWizard
│   ├── useExpenseStore ❌ (커플링)
│   ├── AIService ❌ (직접 호출)
│   └── useLocation (라우팅)
├── MenuDrawer
└── Login/Register

ExpenseList
├── useExpenseStore
├── EditExpenseDialog
│   └── useExpenseStore
└── (필터링/정렬 로직 포함)

ImageUpload
├── ImageService ❌ (직접 호출)
└── useExpenseStore ❌ (커플링)

ManualEntry
└── useExpenseStore

RecurringExpenses
└── useExpenseStore (또는 직접 서비스 호출?)

Statistics
└── useExpenseStore
```

## 5. 리팩토링 계획

### 5.1 단계별 리팩토링

#### Phase 1: 인증 레이어 분리
- [ ] `__root.tsx`에서 인증 로직을 별도 컴포넌트로 분리
- [ ] 인증 가드 컴포넌트 생성 (`AuthGuard`)
- [ ] 레이아웃 컴포넌트 분리 (`AppLayout`)

#### Phase 2: 서비스 레이어 통일
- [ ] 모든 컴포넌트가 Store를 통해서만 데이터 접근하도록 변경
- [ ] Store에서 Service 호출만 담당하도록 명확히 분리
- [ ] ImageUpload: `ImageService` 직접 호출 제거, Store 메서드 추가
- [ ] FloatingChatWizard: `AIService` 직접 호출 제거, Store 메서드 추가

#### Phase 3: Store 책임 분리
- [ ] `expenseStore`에 이미지 업로드 관련 메서드 추가
- [ ] `expenseStore`에 AI 관련 메서드 추가 (또는 별도 `aiStore` 생성)
- [ ] Store는 순수하게 상태 관리와 Service 호출만 담당

#### Phase 4: 비즈니스 로직 분리
- [ ] ExpenseList의 필터링/정렬 로직을 커스텀 훅으로 분리 (`useExpenseFilter`)
- [ ] 통계 계산 로직을 유틸리티 함수로 분리 (이미 `statistics.ts`에 있음)

#### Phase 5: 컴포넌트 책임 명확화
- [ ] 프레젠테이션 컴포넌트와 컨테이너 컴포넌트 분리
- [ ] 재사용 가능한 UI 컴포넌트는 `components/ui`에 유지
- [ ] 페이지별 컨테이너 컴포넌트는 `components/containers`로 분리

### 5.2 목표 아키텍처

```
┌─────────────────────────────────────┐
│         Routes                       │
│  (라우팅만 담당)                      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Container Components            │
│  (데이터 페칭, 상태 관리)              │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│    Presentation Components          │
│  (UI 렌더링만 담당)                   │
└──────────────────────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         Custom Hooks                 │
│  (비즈니스 로직, 재사용 가능한 로직)     │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         Stores                       │
│  (상태 관리, Service 호출)            │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         Services                     │
│  (API 호출, 데이터 변환)               │
└──────────────────────────────────────┘
```

## 6. 구현 우선순위

1. **높은 우선순위**: 인증 레이어 분리 (사용자 경험에 직접 영향)
2. **높은 우선순위**: 서비스 레이어 통일 (유지보수성 향상)
3. **중간 우선순위**: Store 책임 분리 (확장성 향상)
4. **중간 우선순위**: 비즈니스 로직 분리 (테스트 용이성)
5. **낮은 우선순위**: 컴포넌트 구조 개선 (코드 가독성)
