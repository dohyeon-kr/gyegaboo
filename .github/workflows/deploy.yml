name: Release & Deploy Gyegaboo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  release:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run semantic-release || true


  deploy:
    runs-on: self-hosted
    needs: release

    steps:
      - uses: actions/checkout@v4

      # ğŸ”¹ Build
      - name: Build
        run: |
          export NVM_DIR="$HOME/.nvm"
          source "$NVM_DIR/nvm.sh"

          npm ci
          npm run build

      # ğŸ”¹ ì„œë²„ ì‹¤í–‰ ë””ë ‰í† ë¦¬ë¡œ ë™ê¸°í™” (shared ì œì™¸)
      - name: Sync App Code
        run: |
          APP_ROOT=/home/ec2-user/apps/gyegaboo

          mkdir -p "$APP_ROOT"

          rsync -a --delete \
            --exclude shared \
            --exclude node_modules \
            --exclude .git \
            ./ "$APP_ROOT/"

      # ğŸ”¹ Shared ë””ë ‰í† ë¦¬ ë° ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ ì„¤ì •
      - name: Setup Shared Directory Permissions
        run: |
          APP_ROOT=/home/ec2-user/apps/gyegaboo
          
          # shared ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          mkdir -p "$APP_ROOT/shared/data"
          mkdir -p "$APP_ROOT/shared/uploads/profiles"
          mkdir -p "$APP_ROOT/shared/uploads/receipts"
          
          # í˜„ì¬ ì‚¬ìš©ì í™•ì¸
          CURRENT_USER=$(whoami)
          echo "Current user: $CURRENT_USER"
          
          # ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ê¸° ì „ìš© ì†ì„± ì œê±°
          if [ -f "$APP_ROOT/shared/data/gyegaboo.db" ]; then
            echo "Removing read-only attribute from database file..."
            chattr -i "$APP_ROOT/shared/data/gyegaboo.db" 2>/dev/null || true
            chmod 666 "$APP_ROOT/shared/data/gyegaboo.db" || true
          fi
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì ê¸ˆ íŒŒì¼ë„ ì œê±° (ìˆëŠ” ê²½ìš°)
          rm -f "$APP_ROOT/shared/data/gyegaboo.db-shm" 2>/dev/null || true
          rm -f "$APP_ROOT/shared/data/gyegaboo.db-wal" 2>/dev/null || true
          
          # ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì • (ì“°ê¸° ê°€ëŠ¥)
          chmod -R 777 "$APP_ROOT/shared" || chmod -R 755 "$APP_ROOT/shared"
          
          # ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ê¶Œí•œ ì¬ì„¤ì •
          if [ -f "$APP_ROOT/shared/data/gyegaboo.db" ]; then
            chmod 666 "$APP_ROOT/shared/data/gyegaboo.db" || chmod 664 "$APP_ROOT/shared/data/gyegaboo.db"
          fi
          
          # ì†Œìœ ê¶Œ ì„¤ì • (ec2-userê°€ ì†Œìœ í•˜ë„ë¡)
          sudo chown -R ec2-user:ec2-user "$APP_ROOT/shared" 2>/dev/null || chown -R ec2-user:ec2-user "$APP_ROOT/shared" 2>/dev/null || true
          
          # ê¶Œí•œ í™•ì¸
          echo "Database file permissions:"
          ls -la "$APP_ROOT/shared/data/gyegaboo.db" 2>/dev/null || echo "Database file does not exist yet"
          echo "Shared directory permissions:"
          ls -ld "$APP_ROOT/shared" || true

      # ğŸ”¹ Green-Blue ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Green-Blue Deploy
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          export NVM_DIR="$HOME/.nvm"
          source "$NVM_DIR/nvm.sh"

          APP_ROOT=/home/ec2-user/apps/gyegaboo
          cd "$APP_ROOT"

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x scripts/deploy-green-blue.sh || true
          
          # ë°°í¬ ì‹¤í–‰
          bash scripts/deploy-green-blue.sh || {
            echo "Green-Blue ë°°í¬ ì‹¤íŒ¨"
            exit 1
          }

      # ğŸ”¹ íŠ¸ë˜í”½ ì „í™˜ (ì„ íƒì‚¬í•­ - nginx ì‚¬ìš© ì‹œ)
      - name: Switch Traffic
        run: |
          export NVM_DIR="$HOME/.nvm"
          source "$NVM_DIR/nvm.sh"

          APP_ROOT=/home/ec2-user/apps/gyegaboo
          cd "$APP_ROOT"

          chmod +x scripts/switch-traffic.sh || true
          bash scripts/switch-traffic.sh || echo "íŠ¸ë˜í”½ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ (nginx ì—†ì„ ìˆ˜ ìˆìŒ)"

